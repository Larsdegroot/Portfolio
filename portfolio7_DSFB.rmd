# Portfolio assignment 7

```{r}
source(here("src/port_src7.R"))
```

**1. Load the flu (“./data/flu_data.csv), the dengue (.”/data/dengue_data.csv) and the gapminder ({dslabs} package) into three separate dataframes in R.**

```{r}
dengue <- read.csv(here::here("7_data/dengue_data.txt"), skip = 11) 
head(dengue)

flu <- read.csv(here::here("7_data/flu_data.txt"), skip = 11)
head(flu)

head(gapminder)
```

**2. Check if they are in the right shape. Is the data in the ‘tidy’ format? If not change the format to ‘tidy’**

```{r 7.2}
dengue <- dengue %>% pivot_longer(Argentina:Venezuela, names_to = "country", values_to = "value")
head(dengue)

flu <- flu %>% pivot_longer(Argentina:Uruguay, names_to = "country", values_to = "value")
head(flu)

```


**3. Change the country and date variables of the three tables so that they coincide in terms of data type, class and values**

```{r 7.3}
dengue <- dengue %>% separate("Date", into = c("year", "month", "day"), sep = "-") 

dengue <- dengue[-c(2,3)] 
dengue$year <- as.integer(dengue$year)
dengue$country <- as.factor(dengue$country)

dengue <- dengue %>% 
            group_by(year, country) %>% 
            summarise("country" = country, "dengue_activity" = sum(value, na.rm = T)) %>%
            unique()

head(dengue)


flu <- flu %>% separate("Date", into = c("year", "month", "day"), sep = "-") 

flu <- flu[-c(2,3)] 
flu$year <- as.integer(flu$year)
flu$country <- as.factor(flu$country)

flu <- flu %>% 
        group_by(year, country) %>% 
        summarise("country" = country, "influenza_activity" = sum(value, na.rm = T)) %>%
        unique()

head(flu)
```

**4. Store the three tables as separate (so six in total) .csv and .rds files.**

```{r, eval=F}
for (x in c("flu", "dengue", "gapminder")) {
  export(get(x), path = paste0(here("7_data//"), x))
}

```


**5. In Dbeaver create a new PostgreSQL database “workflowsdb”**

```{r, fig.cap = "The workflows database in Dbeaver."}
knitr::include_graphics(here("7_data/workflowsdb_in_Dbeaver.JPG"))
```

![Workflows database in DBeaver](/)

**6. Using RPostgreSQL, insert the tables into the database.**

```{r}
psswd <- .rs.askForPassword("Database Password:")

con <- dbConnect(RPostgres::Postgres(), 
                 dbname = "workflowsdb", 
                 host="localhost", 
                 port="5432", 
                 user="postgres", 
                 password=psswd)
```

```{r, eval=FALSE}
dbWriteTable(con, "dengueDB", dengue, overwrite = T)
dbWriteTable(con, "fluDB", flu, overwrite = T)
dbWriteTable(con, "gapminderDB", gapminder, overwrite = T)
````


**7. Inspect the contents of the tables with SQL (in DBeaver) and save the SQL script.**

```{sql connection= con}
SELECT *  FROM "dengueDB";
```

```{sql connection= con}
SELECT *  FROM "fluDB";
```

```{sql connection= con}
SELECT *  FROM "gapminderDB";
```

**8. Inspect the contents of the tables with dplyr (in R) and save a RMarkdown showing what you are doing.**

```{r}
db_names <- c("fluDB", "dengueDB", "gapminderDB")

tables <- list()
for (i in db_names){
   tables[[paste(i)]] <- dbReadTable(con, i)
}
```

```{r 7.8 inspection}
general_inspection(tables$fluDB, tables$fluDB$year, tables$fluDB$influenza_activity)
general_inspection(tables$dengueDB, tables$dengueDB$year, tables$dengueDB$dengue_activity)
general_inspection(tables$gapminderDB)
```


**9. Load the gapminder data in R and change the dataframe in such as way that you could join it to dengue and flue.**

```{r}
tables$fluDB$year %>% unique()
tables$dengueDB$year %>% unique()
```
The data of `flu` and `dengue` are from the year 2002 untill 2015. while the data of gapminder is from:

```{r}
tables$gapminderDB$year %>% unique()
```
1960 till 2015. we've also seen in 7.8 that the flu data has 406 rows while the dengue data has 140 rows. 

```{r}
# db_names <- c("tables$fluDB$country", "tables$dengueDB$country", "tables$gapminderDB$country")
# for (i in db_names){
#   amount_factor(get(i)) 
# } 

amount_factor(tables$fluDB$country)
amount_factor(tables$dengueDB$country)
amount_factor(tables$gapminderDB$country)

```
```{r}
levelF <- tables$fluDB$country %>% as.factor %>% levels()
levelD <- tables$dengueDB$country %>% as.factor %>% levels()
levelG <- tables$gapminderDB$country %>% as.factor %>% levels()

common(levelD, levelG)
```
All the countries in the dengue data set are all also in the gapminder dataset.

```{r}
common(levelD, levelF)
common(levelF, levelG) %>% length()
```
but the flu data set only has `r common(levelD, levelF)` in common with the dengue data set.



If the tables are to be joined they need to have data about only the countries and years equal to the counties and years that the tables have in common. Or the tables need to be joined in a way that `NA` is introduced where necessary.

```{r}
gapminder_02_15 <- tables$gapminderDB %>% filter(between(year, 2002, 2015))
```

**10. Save this clean gapminder data in the “workflowsdb” database**

```{r, eval=FALSE}
dbWriteTable(con, "gapminder_02_15DB", gapminder_02_15, overwrite = T)
```


**11. Perform some joins (your choice) with SQL (can be done in DBeaver or with dplyr).**

```{sql connection = con}
SELECT "gapminder_02_15DB".*, "fluDB".influenza_activity, "dengueDB".dengue_activity 
FROM "gapminder_02_15DB"
LEFT JOIN "fluDB" ON public."fluDB".year = public."gapminder_02_15DB".year 
AND public."fluDB".country = public."gapminder_02_15DB".country
LEFT JOIN "dengueDB" ON public."dengueDB".year = public."gapminder_02_15DB".year
AND public."dengueDB".country = public."gapminder_02_15DB".country
```

**12. Generate a joined table, and export this from the database to R.**

```{sql connection = con, eval = F}
CREATE TABLE joined_gapfluden 
AS SELECT "gapminder_02_15DB".*, "fluDB".influenza_activity, "dengueDB".dengue_activity 
FROM "gapminder_02_15DB"
LEFT JOIN "fluDB" ON public."fluDB".year = public."gapminder_02_15DB".year 
AND public."fluDB".country = public."gapminder_02_15DB".country
LEFT JOIN "dengueDB" ON public."dengueDB".year = public."gapminder_02_15DB".year
AND public."dengueDB".country = public."gapminder_02_15DB".country
```


```{r}
joined_gapfluden <- dbReadTable(conn = con, "joined_gapfluden")
```

```{r, eval=FALSE}
dbDisconnect(con)
```

**13. Show some descriptive statistics with this table, and at least 3 visualisations using ggplot2.**

First of all, there is no description what `influenza activity` actually is. Because its only positive integers I assume that it means amount of individuals infected. So i want to see if population has a correlation with `influenza activity`.

```{r}
joined_gapfluden %>% filter(influenza_activity > 0) %>%
  ggplot(aes(x= influenza_activity, y=population))+
  geom_point() +
  facet_wrap(~year)
```


