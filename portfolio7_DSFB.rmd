# Portfolio assignment 7

```{r}
source(here("src/port_src7.R"))
```

## 1. Load the flu (“./data/flu_data.csv), the dengue (.”/data/dengue_data.csv) and the gapminder ({dslabs} package) into three separate dataframes in R

```{r}
dengue <- read.csv(here::here("7_data/dengue_data.txt"), skip = 11) 
head(dengue)

flu <- read.csv(here::here("7_data/flu_data.txt"), skip = 11)
head(flu)

head(gapminder)
```

## 2. Check if they are in the right shape. Is the data in the ‘tidy’ format? If not change the format to ‘tidy’

```{r 7.2}
dengue <- dengue %>% pivot_longer(Argentina:Venezuela, names_to = "country", values_to = "value")
head(dengue)

flu <- flu %>% pivot_longer(Argentina:Uruguay, names_to = "country", values_to = "value")
head(flu)

```


## 3. Change the country and date variables of the three tables so that they coincide in terms of data type, class and values

```{r 7.3}
dengue <- dengue %>% separate("Date", into = c("year", "month", "day"), sep = "-") 

dengue <- dengue[-c(2,3)] 
dengue$year <- as.integer(dengue$year)
dengue$country <- as.factor(dengue$country)

dengue <- dengue %>% 
            group_by(year, country) %>% 
            summarise("country" = country, "dengue_activity" = sum(value, na.rm = T)) %>%
            unique()

head(dengue)


flu <- flu %>% separate("Date", into = c("year", "month", "day"), sep = "-") 

flu <- flu[-c(2,3)] 
flu$year <- as.integer(flu$year)
flu$country <- as.factor(flu$country)

flu <- flu %>% 
        group_by(year, country) %>% 
        summarise("country" = country, "influenza_activity" = sum(value, na.rm = T)) %>%
        unique()

head(flu)
```

## 4. Store the three tables as separate (so six in total) .csv and .rds files.

```{r}
for (x in c("flu", "dengue", "gapminder")) {
  export(get(x), path = paste0(here("7_data//"), x))
}

```


## 5. In Dbeaver create a new PostgreSQL database “workflowsdb”

```{r, fig.cap = "The workflows database in Dbeaver."}
knitr::include_graphics(here("7_data/workflowsdb_in_Dbeaver.JPG"))
```

![Workflows database in DBeaver](/)

## 6. Using RPostgreSQL, insert the tables into the database.

```{r, eval=FALSE}
psswd <- .rs.askForPassword("Database Password:")

con <- dbConnect(RPostgres::Postgres(), 
                 dbname = "workflowsdb", 
                 host="localhost", 
                 port="5432", 
                 user="postgres", 
                 password=psswd)

dbWriteTable(con, "dengue", dengue, overwrite = T)
dbWriteTable(con, "flu", flu, overwrite = T)
dbWriteTable(con, "gapminder", gapminder, overwrite = T)

```


## 7. Inspect the contents of the tables with SQL (in DBeaver) and save the SQL script.

```{sql connection= con}
SELECT *  FROM dengue;
```
```{sql connection= con}
SELECT *  FROM flu;
```

```{sql connection= con}
SELECT *  FROM gapminder;
```


```{r, eval=FALSE}
dbDisconnect(con)
```

## 8. Inspect the contents of the tables with dplyr (in R) and save a RMarkdown showing what you are doing.

```{r i want to improve this chunk}
flu <- dbReadTable(conn = con, flu)
dengue <- dbReadTable(conn = con, dengue)
gapminder <- dbReadTable(conn = con, gapminder)
```


```{r ask about this chunk, eval=FALSE}
db_names<- paste(c("flu", "dengue", "gapminder"), "data", sep = " ")

for (i in db_names){
   <- dbReadTable(con, i) 
}

replicate(db_names, dbReadTable(), conn = con)

# im trying to pass conn = con to dbreadtable (...)
#the goal is to read the datatables from sql into a diffrent element each itteration
#maybe one way is to add the datatable into a new part of the list each itteration
lst(db_names)
```
```{r 7.8 inspection}
#user defined function doesn't work see issue #8
general_inspection(flu, year, influenza_activity)
general_inspection(dengue, year, dengue_activity)
general_inspection(gapminder)
```


## 9. Load the gapminder data in R and change the dataframe in such as way that you could join it to dengue and flue.

```{r}
flu$year %>% unique()
dengue$year %>% unique()
```
The data of `flu` and `dengue` are from the year 2002 untill 2015. while the data of gapminder is:

```{r}
gapminder$year %>% unique()
```
More than that.

```{r}
gapminder_02_15 <- gapminder %>% filter(year == 2002:2015)
```

## 10. Save this clean gapminder data in the “workflowsdb” database

```{r}
dbWriteTable(con, "gapminder_02_15", gapminder_02_15, overwrite = T)
```


## 11. Perform some joins (your choice) with SQL (can be done in DBeaver or with dplyr).

```{sql connection = con}
SELECT * 
FROM "gapminder_02_15"
LEFT JOIN "flu" ON flu.year = gapminder_02_15.year
LEFT JOIN "dengue" ON dengue.year = gapminder_02_15.year
```
```{r}
#how to not include year..10 and year..13?
```

## 12. Generate a joined table, and export this from the database to R.

```{sql connection = con}
SELECT gapminder_02_15.*, flu.influenza_activity, dengue.dengue_activity 
FROM "gapminder_02_15"
LEFT JOIN "flu" ON flu.year = gapminder_02_15.year
LEFT JOIN "dengue" ON dengue.year = gapminder_02_15.year
```

## 13. Show some descriptive statistics with this table, and at least 3 visualisations using ggplot2.

```{r}

```


